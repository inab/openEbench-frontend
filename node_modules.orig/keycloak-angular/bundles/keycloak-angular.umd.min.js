!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("rxjs"),require("keycloak-js"),require("rxjs/operators"),require("@angular/common"),require("@angular/common/http"),require("@angular/core")):"function"==typeof define&&define.amd?define("keycloak-angular",["exports","rxjs","keycloak-js","rxjs/operators","@angular/common","@angular/common/http","@angular/core"],t):t(e["keycloak-angular"]={},e.rxjs,e.Keycloak,e.rxjs.operators,e.ng.common,e.ng.common.http,e.ng.core)}(this,function(e,t,r,s,n,i,o){"use strict";var u={OnAuthError:0,OnAuthLogout:1,OnAuthRefreshError:2,OnAuthRefreshSuccess:3,OnAuthSuccess:4,OnReady:5,OnTokenExpired:6};function a(t,s,u,c){return new(u||(u=Promise))(function(e,r){function n(e){try{i(c.next(e))}catch(t){r(t)}}function o(e){try{i(c["throw"](e))}catch(t){r(t)}}function i(t){t.done?e(t.value):new u(function(e){e(t.value)}).then(n,o)}i((c=c.apply(t,s||[])).next())})}function l(n,o){var i,s,u,e,c={label:0,sent:function(){if(1&u[0])throw u[1];return u[1]},trys:[],ops:[]};return e={next:t(0),"throw":t(1),"return":t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function r(e){if(i)throw new TypeError("Generator is already executing.");for(;c;)try{if(i=1,s&&(u=2&e[0]?s["return"]:e[0]?s["throw"]||((u=s["return"])&&u.call(s),0):s.next)&&!(u=u.call(s,e[1])).done)return u;switch(s=0,u&&(e=[2&e[0],u.value]),e[0]){case 0:case 1:u=e;break;case 4:return c.label++,{value:e[1],done:!1};case 5:c.label++,s=e[1],e=[0];continue;case 7:e=c.ops.pop(),c.trys.pop();continue;default:if(!(u=0<(u=c.trys).length&&u[u.length-1])&&(6===e[0]||2===e[0])){c=0;continue}if(3===e[0]&&(!u||e[1]>u[0]&&e[1]<u[3])){c.label=e[1];break}if(6===e[0]&&c.label<u[1]){c.label=u[1],u=e;break}if(u&&c.label<u[2]){c.label=u[2],c.ops.push(e);break}u[2]&&c.ops.pop(),c.trys.pop();continue}e=o.call(n,c)}catch(t){e=[6,t],s=0}finally{i=u=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([t,e])}}}function c(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||0<t--)&&!(n=i.next()).done;)s.push(n.value)}catch(u){o={error:u}}finally{try{n&&!n.done&&(r=i["return"])&&r.call(i)}finally{if(o)throw o.error}}return s}u[u.OnAuthError]="OnAuthError",u[u.OnAuthLogout]="OnAuthLogout",u[u.OnAuthRefreshError]="OnAuthRefreshError",u[u.OnAuthRefreshSuccess]="OnAuthRefreshSuccess",u[u.OnAuthSuccess]="OnAuthSuccess",u[u.OnReady]="OnReady",u[u.OnTokenExpired]="OnTokenExpired";var h=function(){function e(e,t){this.router=e,this.keycloakAngular=t}return e.prototype.canActivate=function(u,c){var e=this;return new Promise(function(i,s){return a(e,void 0,void 0,function(){var t,r,n,o;return l(this,function(e){switch(e.label){case 0:return e.trys.push([0,4,,5]),[4,(t=this).keycloakAngular.isLoggedIn()];case 1:return t.authenticated=e.sent(),[4,(r=this).keycloakAngular.getUserRoles(!0)];case 2:return r.roles=e.sent(),[4,this.isAccessAllowed(u,c)];case 3:return n=e.sent(),i(n),[3,5];case 4:return o=e.sent(),s("An error happened during access validation. Details:"+o),[3,5];case 5:return[2]}})})})},e}(),f=r,d=function(){function e(){this._keycloakEvents$=new t.Subject}return e.prototype.bindsKeycloakEvents=function(){var t=this;this._instance.onAuthError=function(e){t._keycloakEvents$.next({args:e,type:u.OnAuthError})},this._instance.onAuthLogout=function(){t._keycloakEvents$.next({type:u.OnAuthLogout})},this._instance.onAuthRefreshSuccess=function(){t._keycloakEvents$.next({type:u.OnAuthRefreshSuccess})},this._instance.onAuthRefreshError=function(){t._keycloakEvents$.next({type:u.OnAuthRefreshError})},this._instance.onAuthSuccess=function(){t._keycloakEvents$.next({type:u.OnAuthSuccess})},this._instance.onTokenExpired=function(){t._keycloakEvents$.next({type:u.OnTokenExpired})},this._instance.onReady=function(e){t._keycloakEvents$.next({args:e,type:u.OnReady})}},e.prototype.loadExcludedUrls=function(e){var t,r,n=[];try{for(var o=function c(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}}(e),i=o.next();!i.done;i=o.next()){var s=i.value,u=void 0;u="string"==typeof s?{urlPattern:new RegExp(s,"i"),httpMethods:[]}:{urlPattern:new RegExp(s.url,"i"),httpMethods:s.httpMethods},n.push(u)}}catch(a){t={error:a}}finally{try{i&&!i.done&&(r=o["return"])&&r.call(o)}finally{if(t)throw t.error}}return n},e.prototype.initServiceValues=function(e){var t=e.enableBearerInterceptor,r=void 0===t||t,n=e.loadUserProfileAtStartUp,o=void 0===n||n,i=e.bearerExcludedUrls,s=void 0===i?[]:i,u=e.authorizationHeaderName,c=void 0===u?"Authorization":u,a=e.bearerPrefix,l=void 0===a?"bearer":a,h=e.initOptions;this._enableBearerInterceptor=r,this._loadUserProfileAtStartUp=o,this._authorizationHeaderName=c,this._bearerPrefix=l.trim().concat(" "),this._excludedUrls=this.loadExcludedUrls(s),this._silentRefresh=!!h&&"implicit"===h.flow},e.prototype.init=function(n){var i=this;return void 0===n&&(n={}),new Promise(function(r,o){i.initServiceValues(n);var e=n.config,t=n.initOptions;i._instance=f(e),i.bindsKeycloakEvents(),i._instance.init(t).success(function(t){return a(i,void 0,void 0,function(){return l(this,function(e){switch(e.label){case 0:return t&&this._loadUserProfileAtStartUp?[4,this.loadUserProfile()]:[3,2];case 1:e.sent(),e.label=2;case 2:return r(t),[2]}})})}).error(function(e){var t="An error happened during Keycloak initialization.";if(e){var r=e.error,n=e.error_description;t=t.concat("\nAdapter error details:\nError: "+r+"\nDescription: "+n)}o(t)})})},e.prototype.login=function(r){var n=this;return void 0===r&&(r={}),new Promise(function(t,e){n._instance.login(r).success(function(){return a(n,void 0,void 0,function(){return l(this,function(e){switch(e.label){case 0:return this._loadUserProfileAtStartUp?[4,this.loadUserProfile()]:[3,2];case 1:e.sent(),e.label=2;case 2:return t(),[2]}})})}).error(function(){return e("An error happened during the login.")})})},e.prototype.logout=function(n){var o=this;return new Promise(function(e,t){var r={redirectUri:n};o._instance.logout(r).success(function(){o._userProfile=undefined,e()}).error(function(){return t("An error happened during logout.")})})},e.prototype.register=function(r){var n=this;return void 0===r&&(r={action:"register"}),new Promise(function(e,t){n._instance.register(r).success(function(){e()}).error(function(){return t("An error happened during the register execution.")})})},e.prototype.isUserInRole=function(e,t){var r;return(r=this._instance.hasResourceRole(e,t))||(r=this._instance.hasRealmRole(e)),r},e.prototype.getUserRoles=function(e){void 0===e&&(e=!0);var t=[];if(this._instance.resourceAccess)for(var r in this._instance.resourceAccess)if(this._instance.resourceAccess.hasOwnProperty(r)){var n=this._instance.resourceAccess[r].roles||[];t=t.concat(n)}if(e&&this._instance.realmAccess){var o=this._instance.realmAccess.roles||[];t.push.apply(t,function i(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(c(arguments[t]));return e}(o))}return t},e.prototype.isLoggedIn=function(){return a(this,void 0,void 0,function(){return l(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),this._instance.authenticated?[4,this.updateToken(20)]:[2,!1];case 1:return e.sent(),[2,!0];case 2:return e.sent(),[2,!1];case 3:return[2]}})})},e.prototype.isTokenExpired=function(e){return void 0===e&&(e=0),this._instance.isTokenExpired(e)},e.prototype.updateToken=function(n){var e=this;return void 0===n&&(n=5),new Promise(function(t,r){return a(e,void 0,void 0,function(){return l(this,function(e){return this._silentRefresh?this.isTokenExpired()?r("Failed to refresh the token, or the session is expired"):t(!0):this._instance?this._instance.updateToken(n).success(function(e){t(e)}).error(function(){return r("Failed to refresh the token, or the session is expired")}):r("Keycloak Angular library is not initialized."),[2]})})})},e.prototype.loadUserProfile=function(o){var e=this;return void 0===o&&(o=!1),new Promise(function(r,n){return a(e,void 0,void 0,function(){var t=this;return l(this,function(e){return this._userProfile&&!o?r(this._userProfile):this._instance.authenticated?this._instance.loadUserProfile().success(function(e){t._userProfile=e,r(t._userProfile)}).error(function(){return n("The user profile could not be loaded.")}):n("The user profile was not loaded as the user is not logged in."),[2]})})})},e.prototype.getToken=function(){var r=this;return new Promise(function(t,e){return a(r,void 0,void 0,function(){return l(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,this.updateToken(10)];case 1:return e.sent(),t(this._instance.token),[3,3];case 2:return e.sent(),this.login(),[3,3];case 3:return[2]}})})})},e.prototype.getUsername=function(){if(!this._userProfile)throw new Error("User not logged in or user profile was not loaded.");return this._userProfile.username},e.prototype.clearToken=function(){this._instance.clearToken()},e.prototype.addTokenToHeader=function(o){var e=this;return void 0===o&&(o=new i.HttpHeaders),t.Observable.create(function(n){return a(e,void 0,void 0,function(){var t,r;return l(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,this.getToken()];case 1:return t=e.sent(),o=o.set(this._authorizationHeaderName,this._bearerPrefix+t),n.next(o),n.complete(),[3,3];case 2:return r=e.sent(),n.error(r),[3,3];case 3:return[2]}})})})},e.prototype.getKeycloakInstance=function(){return this._instance},Object.defineProperty(e.prototype,"excludedUrls",{get:function(){return this._excludedUrls},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"enableBearerInterceptor",{get:function(){return this._enableBearerInterceptor},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"keycloakEvents$",{get:function(){return this._keycloakEvents$},enumerable:!0,configurable:!0}),e.decorators=[{type:o.Injectable}],e}(),p=function(){function e(e){this.keycloak=e}return e.prototype.isUrlExcluded=function(e,t){var r=e.method,n=e.url,o=t.urlPattern,i=t.httpMethods,s=0===i.length||-1<i.join().indexOf(r.toUpperCase()),u=o.test(n);return s&&u},e.prototype.intercept=function(r,n){var t=this,e=this.keycloak,o=e.enableBearerInterceptor,i=e.excludedUrls;return o?-1<i.findIndex(function(e){return t.isUrlExcluded(r,e)})?n.handle(r):this.keycloak.addTokenToHeader(r.headers).pipe(s.mergeMap(function(e){var t=r.clone({headers:e});return n.handle(t)})):n.handle(r)},e.decorators=[{type:o.Injectable}],e.ctorParameters=function(){return[{type:d}]},e}(),y=function(){function e(){}return e.decorators=[{type:o.NgModule,args:[{imports:[n.CommonModule],providers:[d,{provide:i.HTTP_INTERCEPTORS,useClass:p,multi:!0}]}]}],e}(),v=function(){function e(){}return e.decorators=[{type:o.NgModule,args:[{imports:[y]}]}],e}();e.KeycloakEventType=u,e.KeycloakAuthGuard=h,e.KeycloakService=d,e.KeycloakBearerInterceptor=p,e.CoreModule=y,e.KeycloakAngularModule=v,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=keycloak-angular.umd.min.js.map